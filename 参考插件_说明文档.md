# SkelotRbn 介绍文档

本文讨论了 Epic 商城插件 Skelot 的二次开发扩展 SkelotRbn 的介绍文档，涵盖其功能、使用方法、性能表现、API 等内容...

> 🦁 **SkelotRbn** 是Epic商城插件 **Skelot** 的**二次开发扩展**，专用于**高性能大规模群集渲染**。在原有的高性能骨骼动画实例渲染功能上，集成了完整的**碰撞，空间查询，寻路避障**功能。


## 功能特性

### 原有功能

* **大规模实例渲染**: 支持数w个骨骼动画角色同屏显示，基于GPU Instancing技术
* **LOD优化**: 基于距离的更新频率优化，提升远距离实例性能  
* **层级附加**: 支持实例间父子关系

### 扩展功能

* **快速资产创建**: 右键选择网格体资产，自动创建对应资产
* **PBD碰撞系统**: 实例间自动碰撞避让，防止角色重叠穿插
* **ORCA/RVO避障**: 智能路径规划，实现流畅的群体移动
* **空间检测**: 高效的范围查询，用于子弹碰撞、AOE技能、范围攻击等游戏逻辑
* **配套几何工具**: 提供包括根据Shape组件表面/实心，自定义阵型，样条曲线，网格模型表面/实心/体素的点位生成库，方便批量创建实例

### 注意事项

* 目前仅支持 **UE5.6**
* 本插件仅限公司内部使用，禁止外传。提供授权码与设备绑定。

### 未来路线

* 当前版本 v0.9
* 上述功能已经实现，后续会优化扩展更多功能，比如完善地形支持，更多移动方式，自定义模型等

## 实时演示

实时运行时帧数表现：

(此处为视频/图片展示区)

## 快速入门

▶ **快速入门**

## 性能表现

* 插件Content内提供demo演示关卡，2个实例移动示例，1个几何工具示例  
* 渲染最好使用阴影贴图而非虚拟阴影贴图
* **4-5w** 实例移动（实例间开启相互碰撞），8000面数4级LOD骨骼模型下：
  * **渲染 540x540，2000帧序列，无抗锯齿**，大概 **50s-70s**
  * **渲染 1920x1920，2000帧序列，3倍采样MSAA**，大概 **5min-6min**
* 上面2档可以作为性能参考，适量减量，更换移动模式，更换抗锯齿模式，或者减少渲染总帧数，渲染速度会更快

> 🦁 以下示例均没有超过3分钟，720p-1080p

(此处为视频/图片展示区)

<details>
<summary>功能API（点击展开）</summary>

## 功能API

调用方式：在蓝图中搜索 `Skelot` 或者直接复制下面函数名，即可找到。

### 实例管理

#### Skelot Create Instance
创建一个 Skelot 实例。

**参数**
* `Transform` - 实例的世界变换（位置、旋转、缩放）
* `RenderParams` - 渲染参数资产，定义外观和动画集
* `UserObject` - 可选的用户自定义对象

**返回值**
* 实例句柄，用于后续操作

#### Skelot Create Instances
批量创建多个实例，比循环调用更高效。

**参数**
* `Transforms` - 变换数组
* `RenderParams` - 所有实例共用的渲染参数

**返回值**
* 句柄数组，顺序与输入对应

#### Skelot Destroy Instance
销毁一个 Skelot 实例。

**参数**
* `Handle` - 要销毁的实例句柄

#### Skelot Destroy Instances
批量销毁多个实例。

**参数**
* `Handles` - 要销毁的句柄数组

#### Skelot Set Lifespan
设置实例的生命周期，到期后自动销毁。

**参数**
* `Handle` - 实例句柄
* `Lifespan` - 生命周期（秒），0表示取消自动销毁

### 变换操作

#### Skelot Get Transform
获取实例的世界变换。

**参数**
* `Handle` - 实例句柄

**返回值**
* 世界变换（位置、旋转、缩放）

#### Skelot Set Transform
设置实例的变换。

**参数**
* `Handle` - 实例句柄
* `Transform` - 新的变换
* `bRelative` - false表示世界变换，true表示相对父级变换

#### Skelot Get Socket Transform
获取骨骼或插槽的变换，用于在骨骼位置生成特效。

**参数**
* `Handle` - 实例句柄
* `SocketOrBoneName` - 骨骼或插槽名称
* `InMesh` - 可选，指定网格
* `bWorldSpace` - true表示世界空间，false表示组件空间

**返回值**
* 骨骼/插槽变换

### 动画系统

#### Skelot Play Animation
播放动画。

**参数**
* `Handle` - 实例句柄
* `Params` - 动画播放参数
  * `Animation` - 动画序列
  * `bLoop` - 是否循环
  * `PlayRate` - 播放速率（1.0为正常速度）
  * `StartPosition` - 起始位置（秒）
  * `BlendInTime` - 混合时间（秒）

**返回值**
* 动画长度（秒），失败返回-1

#### Skelot Get Anim Collection
获取实例关联的动画集资产。

**参数**
* `Handle` - 实例句柄

**返回值**
* 动画集资产

### LOD 系统

#### Skelot Set LOD Update Frequency Enabled
启用或禁用基于距离的更新频率优化。

**参数**
* `bEnable` - true表示启用，false表示禁用（所有实例每帧更新）

#### Skelot Is LOD Update Frequency Enabled
检查LOD更新频率是否已启用。

**返回值**
* true表示已启用，false表示已禁用

#### Skelot Set LOD Distances
设置LOD距离阈值。

**参数**
* `MediumDist` - 中距离阈值（厘米），超过后每2帧更新
* `FarDist` - 远距离阈值（厘米），超过后每4帧更新

### 碰撞通道系统

Skelot 使用8个碰撞通道（Channel0-Channel7）控制实例间碰撞。

**核心概念**
* **碰撞通道**: 实例所属通道，即"我是谁"
* **碰撞掩码**: 与哪些通道碰撞，即"我和谁碰撞"
* **默认值**: 新实例属于Channel0，掩码0xFF（与所有通道碰撞）
* **碰撞判定**: `(MaskA & ChannelB) != 0 且 (MaskB & ChannelA) != 0`

#### Skelot Set Instance Collision Mask
设置碰撞掩码，控制与哪些通道碰撞。

**参数**
* `InstanceIndex` - 实例索引
* `Mask` - 碰撞掩码位标志

**掩码值参考**
* `0x01` - 只与Channel0碰撞
* `0x02` - 只与Channel1碰撞
* `0xFF` - 与所有通道碰撞（默认）
* `0x00` - 不与任何通道碰撞

#### Skelot Set Instance Collision Mask By Handle
通过句柄设置碰撞掩码。

**参数**
* `Handle` - 实例句柄
* `Mask` - 碰撞掩码

#### Skelot Get Instance Collision Mask
获取当前碰撞掩码。

**参数**
* `InstanceIndex` - 实例索引

**返回值**
* 当前碰撞掩码

#### Skelot Set Instance Collision Channel
设置实例所属的碰撞通道。

**参数**
* `InstanceIndex` - 实例索引
* `Channel` - 目标通道

#### Skelot Set Instance Collision Channel By Handle
通过句柄设置所属通道。

**参数**
* `Handle` - 实例句柄
* `Channel` - 目标通道

#### Skelot Get Instance Collision Channel
获取当前所属通道。

**参数**
* `InstanceIndex` - 实例索引

**返回值**
* 当前所属通道

### 移动系统

#### Skelot Set Instance Velocity
设置速度向量，用于PBD/ORCA避障。

**参数**
* `Handle` - 实例句柄
* `Velocity` - 速度向量（厘米/秒）

#### Skelot Set Instance Velocity By Index
通过索引设置速度，比Handle版本更快。

**参数**
* `InstanceIndex` - 实例索引
* `Velocity` - 速度向量

#### Skelot Get Instance Velocity
获取当前速度向量。

**参数**
* `Handle` - 实例句柄

**返回值**
* 当前速度向量

#### Skelot Get Instance Velocity By Index
通过索引获取速度。

**参数**
* `InstanceIndex` - 实例索引

**返回值**
* 当前速度向量

#### Skelot Set Instance Velocities
批量设置速度，比循环调用更高效。

**参数**
* `Handles` - 句柄数组
* `Velocities` - 速度数组，需一一对应

#### Skelot Set Instance Velocities By Index
通过索引批量设置速度。

**参数**
* `InstanceIndices` - 索引数组
* `Velocities` - 速度数组

### 空间检测

#### Skelot Query Location Overlapping Sphere
查询球形范围内的实例，用于范围攻击、AOE技能。

**参数**
* `Center` - 球心位置（世界坐标）
* `Radius` - 球体半径（厘米）
* `Instances` - 输出，查询到的句柄
* `CollisionMask` - 掩码过滤，默认全部通道

#### Skelot Set Spatial Grid Cell Size
设置空间网格单元大小，影响查询性能。

**参数**
* `CellSize` - 单元大小（厘米）

**建议**: 设为查询半径的1-2倍

#### Skelot Get Spatial Grid Cell Size
获取当前单元大小。

**返回值**
* 当前单元大小

### 层级关系

#### Skelot Attach Child
将实例附加到另一个实例，形成父子关系。

**参数**
* `Parent` - 父实例句柄
* `Child` - 子实例句柄
* `SocketOrBoneName` - 附加到的骨骼/插槽名
* `Transform` - 相对变换
* `bKeepWorldTransform` - true表示保持世界位置

#### Skelot Detach From Parent
将实例从父级分离。

**参数**
* `Handle` - 要分离的句柄

#### Skelot Get Children
获取所有子实例。

**参数**
* `Handle` - 父实例句柄

**返回值**
* `Children` - 输出，子实例句柄

#### Skelot Get Parent
获取父实例。

**参数**
* `Handle` - 实例句柄

**返回值**
* 父实例句柄，无父级返回无效句柄

### 几何工具

用于生成点阵，批量生成实例位置。

#### Get Bezier Point
计算贝塞尔曲线上的点。

**参数**
* `Points` - 控制点数组
* `Progress` - 曲线进度（0.0-1.0）

**返回值**
* 曲线上的点坐标

#### Get Points By Shape
在形状组件内生成均匀分布的点。

**参数**
* `Shape` - 形状组件（球/盒/胶囊）
* `Distance` - 点间距
* `bSurfaceOnly` - true表示仅表面，false表示填充体积
* `Noise` - 随机偏移量，0表示规则排列

**返回值**
* 点坐标数组

#### Get Points By Round
在XY平面圆形区域内生成点。

**参数**
* `Origin` - 圆心位置
* `Radius` - 圆半径
* `Distance` - 点间距
* `Noise` - 随机偏移量

**返回值**
* 点坐标数组

#### Get Points By Grid
按网格模式生成点（1D/2D/3D）。

**参数**
* `Origin` - 网格起点
* `DistanceX` - X方向间距
* `CountX` - X方向数量
* `County` - Y方向数量（1表示1D）
* `DistanceY` - Y方向间距
* `CountZ` - Z方向数量（1表示2D）
* `DistanceZ` - Z方向间距

**返回值**
* 点坐标数组

#### Get Points By Mesh
在静态网格表面生成随机点。

**参数**
* `Mesh` - 静态网格资产
* `Transform` - 网格变换
* `Distance` - 目标点间距
* `Noise` - 随机偏移量
* `LODIndex` - LOD级别（0为最高）

**返回值**
* 点坐标数组

#### Get Points By Mesh Voxel
在静态网格上生成体素化点。

**参数**
* `Mesh` - 静态网格资产
* `Transform` - 网格变换
* `VoxelSize` - 体素大小
* `bSolid` - true表示实心，false表示外壳
* `Noise` - 随机偏移量
* `LODIndex` - LOD级别

**返回值**
* 点坐标数组

#### Get Points By Spline
沿样条曲线生成点。

**参数**
* `Spline` - 样条组件
* `CountX` - 沿样条方向点数
* `CountY` - 垂直方向点数（形成带状）
* `Width` - 带状宽度
* `Noise` - 随机偏移量

**返回值**
* 点坐标数组

#### Get Pixels By Texture
从纹理获取像素数据。

**参数**
* `Texture` - 纹理资产
* `SampleStep` - 采样步长，1表示全部，3表示每3个取1个

**返回值**
* 像素数据（颜色和UV）

</details>

<details>
<summary>碰撞通道枚举（点击展开）</summary>

## 碰撞通道枚举

Skelot 使用8个碰撞通道控制实例间碰撞：

| 通道 | 值 | 说明 |
|------|----|------|
| Channel0 | 0x01 | 默认通道 |
| Channel1 | 0x02 | 可配置通道 |
| Channel2 | 0x04 | 可配置通道 |
| Channel3 | 0x08 | 可配置通道 |
| Channel4 | 0x10 | 可配置通道 |
| Channel5 | 0x20 | 可配置通道 |
| Channel6 | 0x40 | 可配置通道 |
| Channel7 | 0x80 | 可配置通道 |

</details>

<details>
<summary>PBD/RVO 配置（点击展开）</summary>

## PBD/RVO 配置

PBD和RVO参数通过场景中的 `Skelot PBD Plane` Actor配置。

### 使用方法

1. 放置 `Skelot PBD Plane` Actor
2. 配置PBD和RVO参数
3. 参数自动应用到SkelotWorld

**障碍物**: 使用 `Skelot Sphere Obstacle` 和 `Skelot Box Obstacle` Actor

### 推荐配置（高性能 + 不抖动 + 不重叠）

#### PBD 参数

| 参数 | 推荐值 | 说明 |
|------|--------|------|
| 启用PBD碰撞 | true | 开启实例间碰撞 |
| PBD碰撞半径 | 50-80 | 根据角色体型调整，过小会重叠 |
| PBD迭代次数 | 3 | 平衡性能和稳定性，2-4都可以 |
| 障碍后额外迭代 | 1 | 有障碍物时增加稳定性 |
| PBD松弛系数 | 0.3-0.6 | 越低越稳定但响应慢，推荐0.3 |
| PBD网格尺寸倍率 | 1.0 | 保持默认 |
| PBD最大邻居数 | 64 | 密集场景可增加到128 |
| PBD更新频率 | 1 | 每帧更新，保证稳定 |
| 启用速度投影 | true | 防止穿透后抖动 |
| 速度投影强度 | 0.8-1.0 | 越高越稳定 |
| 速度恢复速率 | 2.0 | 碰撞后恢复原速度的速率 |
| 最大推力系数 | 1.5 | 深度重叠时的推力上限 |

#### RVO/ORCA 参数

| 参数 | 推荐值 | 说明 |
|------|--------|------|
| 启用RVO/ORCA | true | 开启智能避障 |
| RVO邻居半径 | 200-400 | 约为碰撞半径的4-6倍 |
| RVO时间窗 | 0.5-1.0s | 越大越提前避障，但可能过度绕行 |
| RVO最大速度 | 0 | 0=使用当前速度 |
| RVO最小速度 | 50-100 | 防止完全停止 |
| 到达半径 | 150-300 | 接近目标时减速范围 |
| 到达密度阈值 | 4-8 | 防止目标点过度拥挤 |
| RVO最大邻居数 | 12-20 | 平衡精度和性能 |
| RVO分帧步长 | 1-2 | 2可降低50%计算量 |

#### 抗抖动关键配置

| 参数 | 推荐值 | 说明 |
|------|--------|------|
| 启用密度自适应 | true | 高密度时自动降低响应 |
| 密度阈值 | 8 | 邻居数超过此值触发自适应 |
| 高密度松弛系数 | 0.3 | 高密度时的松弛系数 |
| 启用速度平滑 | true | 平滑速度变化防止抖动 |
| 速度平滑系数 | 0.15 | 越大越平滑，但响应变慢 |
| 启用抖动检测 | true | 自动检测并抑制抖动 |
| 抖动检测阈值 | 0.7 | 方向变化超过此值视为抖动 |
| 抖动抑制强度 | 0.5 | 检测到抖动时的抑制力度 |

### 调试建议

> **提示**：如果仍有抖动，优先调整：
>
> 1. 增加 PBD迭代次数（3 → 4）
> 2. 降低 PBD松弛系数（0.6 → 0.3）
> 3. 增加速度平滑系数（0.15 → 0.25）

</details>